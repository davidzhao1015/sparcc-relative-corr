---
title: "Relative correlation of microbiome with SparCC"
author: "David Xin Zhao"
date: "Last edited `r format(Sys.time(), '%d %B %Y')`"
knit: (function(inputFile, encoding) {
      out_dir <- 'docs';
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_file=file.path(dirname(inputFile), out_dir, 'index.html'))})
output:
  html_document:
    # theme: cosmo
    highlight: pygments
    df_print: paged
    toc: TRUE
    toc_float: TRUE
    collapsed: FALSE
    number_sections: TRUE
    fig_width: 7
    fig_height: 6
    fig_caption: TRUE
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
---

<html>

<head>

```{=html}
<style>

h1{
 color: #055C9D;
 font-family: Georgia;
 font-size: 200%
}


h2{
 color: #055C9D;
 font-family: helvetica;
 font-size: 150%
}

h3{
 color: #055C9D;  
 font-family: helvetica;
 font-size: 120%; 
}

p {
 color: #333333;
 font-family: helvetica;
 font-size: 100%;
}

.blackbox {
  padding: 1em;
  background: green;
  color: black;
  border: 2px solid orange;
  border-radius: 10px;
}

.center {
  text-align: center;
}

</style>
```
</head>

</html>

```{r setup, include = FALSE}
# set options for the entire document 
knitr::opts_chunk$set(fig.align = 'center', 
                      fig.height=6, fig.width=8,
                      dev="png",
                      echo=TRUE, #display code in output document 
                      error=FALSE,
                      collapse = FALSE, 
                      message=FALSE) #stop render when error occurs   
```

## Problem

Relative abundance data of microbiome is compositional. Classical
statistical associations methods, such as Pearson correlation or
Spearman rank correlation, are invalid when analyzing compositional data
and will lead to spurious correlations.

## Solution

Friedman and Alm (Massachusetts Institute of Technology, MIT) developed
a statistical method, SparCC to infer valid ecological network
(associations) between taxa-taxa in microbiome data by effectively
dealing with compositionality. Experiments using simulated data and the
Human Microbiome Project data proves validity of SparCC.

Researchers provided both Python- and R- based modules to implement
SparCC.

## Resources

-   SparCC paper[@friedman2012]

-   [R package vignette of
    mina](https://rdrr.io/github/Guan06/mina/man/sparcc.html) to
    implement SparCC

-   GitHub repository for [mina
    workflow](https://github.com/Guan06/mina/)

-   [Run R and Python in a single project with reticulated
    package](https://posit.co/blog/three-ways-to-program-in-python-with-rstudio/#:~:text=Run%20Python%20Scripts%20in%20the%20RStudio%20IDE,-The%20RStudio%20IDE&text=You%20can%20write%20scripts%2C%20import,would%20in%20an%20R%20script.)

-   [Github repository](https://github.com/davidzhao1015/SparCC3) for the
    SparCC Python module

## Project purpose

1.  Reproduce SparCC analysis of HMP data in the original paper using
    both Python- and R-based module
    
2.  Apply SparCC method to a new, real data, and compare its results to
    the one based on proportionality analysis

## Scripts

### Load libraries 

```{r library}

library(tidyverse)
library(reticulate)

```

### Load OTU table (absolute count)

```{r}

# raw OTU table
raw_otu <- read.csv(file = "https://knights-lab.github.io/MLRepo/datasets/turnbaugh/refseq/otutable.txt",
                    header=T,
                    sep = "")

```

The raw OTU table contains 557 features (OTUs) in 281 samples.

Shorten OTU identifiers with keeping only genus and species names, using
`stringr` package. And then accumulate counts of OTUs at the species
level.

```{r shorten OTU names}

head(raw_otu$X.OTU) 

# split strings 
otu.id <- raw_otu$X.OTU

split_otu.id <- str_split_fixed(otu.id, "_", n=6) %>% 
        as.data.frame()

# join genus and species fragments 
join_split_otu.id <- split_otu.id %>% 
        mutate(taxa = str_c(V3, V4, sep = " ")) 

taxa <- join_split_otu.id$taxa 

# merge taxa to raw otu table 
raw_otu_taxa <- cbind(raw_otu, taxa) 

# accumulate counts at the species level 
otu_count_splevel <- raw_otu_taxa %>% 
        gather(key = "sample", value = "count", -c("ID", "X.OTU", "taxa")) %>% 
        group_by(sample, taxa) %>%
        summarise(count_sp = sum(count, na.rm = T)) %>% 
        arrange(desc(count_sp)) %>%
        ungroup()

otu_count_splevel2 <- otu_count_splevel %>% 
        spread(key = "sample", value = count_sp) %>%
        rownames_to_column("otu_id")

otu_count_splevel3 <- otu_count_splevel2 

otu_count_splevel4 <- otu_count_splevel3 %>%
  select(-taxa)

# write out otu data frame in .txt 
write.table(otu_count_splevel4, 
            file = "otu_sp.txt",
            sep = "\t", 
            dec = ".",
            row.names = FALSE,
            na= "NA",
            quote = FALSE)  

# read in .txt file 
sp_otu <- read.delim("otu_sp.txt") 

```


### Apply SparCC python3 package to the obese microbiome data 

Fork the SparCC python3 scripts from GitHub repo by a researcher. 

Use git bash commend line to run SparCC python2 module following the package manual. The outputs from SparCC analysis were stored in the main directory of the project.  

```{python, include = FALSE}

# install package 
python ./SparCC3/SparCC.py -h . 

# correlation calculation 
python ./SparCC3/SparCC.py otu_sp.txt -i 5 --cor_file=cor_sparcc_spp.out 
python ./SparCC3/SparCC.py otu_sp.txt -i 5 --cor_file=cor_pearson_spp.out -a pearson 
python ./SparCC3/SparCC.py otu_sp.txt -i 5 --cor_file=cor_spearman_spp.out -a spearman 

# pseudo p-value calculation 
python ./SparCC3/MakeBootstraps.py otu_sp.txt -n 5 -t permutation_#.txt -p ./ 

python ./SparCC3/SparCC.py ./permutation_0.txt -i 5 --cor_file=./perm_cor_spp_0.txt
python ./SparCC3/SparCC.py ./permutation_1.txt -i 5 --cor_file=./perm_cor_spp_1.txt
python ./SparCC3/SparCC.py ./permutation_2.txt -i 5 --cor_file=./perm_cor_spp_2.txt
python ./SparCC3/SparCC.py ./permutation_3.txt -i 5 --cor_file=./perm_cor_spp_3.txt
python ./SparCC3/SparCC.py ./permutation_4.txt -i 5 --cor_file=./perm_cor_spp_4.txt

python ./SparCC3/PseudoPvals.py cor_sparcc_spp.out ./perm_cor_spp_#.txt 5 -o ./pvals_spp.one_sided.txt -t one_sided
python ./SparCC3/PseudoPvals.py cor_sparcc_spp.out ./perm_cor_spp_#.txt 5 -o ./pvals_spp.two_sided.txt -t two_sided

```


### Tabulate output from SparCC analysis 

```{r sparcc output}

# sparcc coefficients 
full_sparcc <- read.delim("cor_sparcc_spp.out", header = TRUE) %>% 
  as.data.frame()  

sp_otu2 <- sp_otu %>% 
  column_to_rownames("otu_id")

# index low abundant taxa
low_abund_index <- apply(sp_otu2, 1, function(x) sum(x >= 10) >= 5) 


full_sparcc2 <- full_sparcc %>% 
  column_to_rownames("otu_id")

full_sparcc3 <- full_sparcc2[low_abund_index, low_abund_index] # for generating heat-map 


# two-sided pval of sparcc coefficients 
two.side_pval_sparcc <- read.delim("pvals_spp.two_sided.txt", header = TRUE) %>% 
  as.data.frame() 

two.side_pval_sparcc2 <- two.side_pval_sparcc %>% 
  column_to_rownames("otu_id")

two.side_pval_sparcc3 <- two.side_pval_sparcc2[low_abund_index, low_abund_index] 

```


### Visualize SparCC output 

```{r corr matrix heatmap, fig.height=6, fig.width=8}

# prepare correlation matrix 
full_sparcc4 <- full_sparcc3 %>%
  rownames_to_column("otu_id") %>% 
  mutate(otu_id = paste("X", otu_id, sep = "")) %>% 
  column_to_rownames("otu_id") %>%
  as.matrix()

two.side_pval_sparcc4 <- two.side_pval_sparcc3 %>%
  rownames_to_column("otu_id") %>% 
  mutate(otu_id = paste("X", otu_id, sep = "")) %>%
  column_to_rownames("otu_id") %>%
  as.matrix()

# heat map based on sparcc coefficients 
corrplot::corrplot(full_sparcc4, 
                   method = "color", 
                   tl.pos = "n", 
                   type="upper", 
                   p.mat = two.side_pval_sparcc4,
                   sig.level = 0.05,
                   insig = "blank")  # empty cells if pval > 0.05 


```


















